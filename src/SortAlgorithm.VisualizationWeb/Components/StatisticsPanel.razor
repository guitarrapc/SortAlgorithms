@using SortAlgorithm.VisualizationWeb.Models

<div class="statistics-panel">
    <h3>üìä Statistics</h3>

    <div class="stat-section">
        <div class="stat-section-title">‚è± Execution Time</div>
        <div class="stat-item">
            <span class="stat-label">@ExecutionTimeLabel</span>
            <span class="stat-value stat-execution-time">@ExecutionTimeDisplay</span>
        </div>
        @if (State.ActualExecutionTime > TimeSpan.Zero)
        {
            <div class="stat-item">
                <span class="stat-label">Performance</span>
                <span class="stat-value stat-performance">@PerformanceDisplay</span>
            </div>
        }
    </div>
    
    <div class="stat-section">
        <div class="stat-section-title">üî¢ Operations</div>
        <div class="stat-item">
            <span class="stat-label">Comparisons</span>
            <span class="stat-value">@State.CompareCount.ToString("N0")</span>
        </div>
        
        <div class="stat-item">
            <span class="stat-label">Swaps</span>
            <span class="stat-value">@State.SwapCount.ToString("N0")</span>
        </div>
        
        <div class="stat-item">
            <span class="stat-label">Index Reads</span>
            <span class="stat-value">@State.IndexReadCount.ToString("N0")</span>
        </div>
        
        <div class="stat-item">
            <span class="stat-label">Index Writes</span>
            <span class="stat-value">@State.IndexWriteCount.ToString("N0")</span>
        </div>
    </div>

    <div class="stat-item">
        <span class="stat-label">Progress</span>
        <span class="stat-value">@ProgressPercentage.ToString("F1")%</span>
    </div>
    
    <div class="stat-item">
        <span class="stat-label">Status</span>
        <span class="stat-value">@StatusText</span>
    </div>
</div>

@code {
    [Parameter]
    public VisualizationState State { get; set; } = new();
    
    private double ProgressPercentage => State.TotalOperations > 0 
        ? (double)State.CurrentOperationIndex / State.TotalOperations * 100 
        : 0;
    
    private string StatusText => State.PlaybackState switch
    {
        PlaybackState.Playing => "‚ñ∂ Playing",
        PlaybackState.Paused => "‚è∏ Paused",
        PlaybackState.Stopped => "‚èπ Stopped",
        _ => "Unknown"
    };

    private bool IsPlaying => State.PlaybackState == PlaybackState.Playing;

    private string ExecutionTimeLabel => IsPlaying ? "Current" : "Total";

    private string ExecutionTimeDisplay
    {
        get
        {
            if (State.ActualExecutionTime == TimeSpan.Zero)
                return "-";

            if (IsPlaying)
            {
                var current = State.EstimatedCurrentExecutionTime;
                return $"{FormatTime(current)} / {FormatTotalTime(State.ActualExecutionTime)}";
            }

            return FormatTotalTime(State.ActualExecutionTime);
        }
    }

    private string PerformanceDisplay
    {
        get
        {
            if (State.ActualExecutionTime == TimeSpan.Zero || State.TotalOperations == 0)
                return "-";

            var opsPerMs = State.TotalOperations / State.ActualExecutionTime.TotalMilliseconds;

            if (opsPerMs < 1)
                return $"{opsPerMs * 1000:F1} ops/s";
            else if (opsPerMs < 1_000_000)
                return $"{opsPerMs:F0} ops/ms";
            else
                return $"{opsPerMs / 1000:F2} M ops/ms";
        }
    }

    /// ÁµåÈÅéÊôÇÈñìÔºàÂÜçÁîü‰∏≠„ÅÆÊé®ÂÆöÂÄ§Ôºâ: Â∞èÊï∞ÁÇπÂõ∫ÂÆöÊ°ÅÔºàF3/F1Ôºâ„ÅßÂ∏∏„Å´„Éï„É´Á≤æÂ∫¶Ë°®Á§∫
    private static string FormatTime(TimeSpan time)
    {
        if (time.TotalNanoseconds < 1000)
            return $"{time.TotalNanoseconds:F0} ns";
        else if (time.TotalMicroseconds < 1000)
            return $"{time.TotalMicroseconds:F1} Œºs";
        else if (time.TotalMilliseconds < 1000)
            return $"{time.TotalMilliseconds:F3} ms";
        else
            return $"{time.TotalSeconds:F3} s";
    }

    /// „Éà„Éº„Çø„É´ÊôÇÈñì: Êú´Â∞æ„Çº„É≠„ÇíÁúÅÁï•„ÅóÂ∞èÊï∞ÁÇπ1Ê°Å‰ª•‰∏ä„Çí‰øùÊåÅ
    /// ‰æã: 200.000ms ‚Üí 200.0ms„ÄÅ200.123ms ‚Üí 200.123ms
    private static string FormatTotalTime(TimeSpan time)
    {
        if (time.TotalNanoseconds < 1000)
            return $"{time.TotalNanoseconds:F0} ns";
        else if (time.TotalMicroseconds < 1000)
            return $"{TrimTrailingZerosMinOne(time.TotalMicroseconds)} Œºs";
        else if (time.TotalMilliseconds < 1000)
            return $"{TrimTrailingZerosMinOne(time.TotalMilliseconds)} ms";
        else
            return $"{TrimTrailingZerosMinOne(time.TotalSeconds)} s";
    }

    /// F3„Åß„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂæå„Å´Êú´Â∞æ„Çº„É≠„Çí„Éà„É™„É†„Åó„ÄÅÂ∞èÊï∞ÁÇπ1Ê°Å„ÇíÊúÄ‰ΩéÈôê‰øùÊåÅ„Åô„Çã
    private static string TrimTrailingZerosMinOne(double value)
    {
        var s = value.ToString("F3").TrimEnd('0');
        if (s.EndsWith('.'))
            s += "0";
        return s;
    }
}

