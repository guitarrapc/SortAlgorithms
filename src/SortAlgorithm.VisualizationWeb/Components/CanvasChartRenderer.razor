@using SortAlgorithm.VisualizationWeb.Models
@using SortAlgorithm.VisualizationWeb.Services
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject DebugSettings DebugSettings
@implements IAsyncDisposable

<div class="bar-chart-container @(State?.PlaybackState == PlaybackState.Playing ? "playing" : "")" 
     @onclick="OnCanvasClick" 
     style="position: relative; width: 100%; height: 100%;">
    
    @if (State != null && State.MainArray.Length > 0)
    {
        <canvas id="@_canvasId" style="width: 100%; height: 100%; display: block;"></canvas>
    }
    else
    {
        <div style="text-align: center; color: #999; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <p style="font-size: 2rem;">üìä</p>
            <p>Click "Generate & Sort" to start visualization</p>
        </div>
    }
</div>

@code {
[Parameter]
public VisualizationState? State { get; set; }
    
[Parameter]
public EventCallback OnClick { get; set; }
    
[Parameter]
public int GridColumnCount { get; set; } = 1;
    
private string _canvasId = $"sortCanvas_{Guid.NewGuid():N}";
private bool _isInitialized = false;
private int _previousGridColumnCount = 0;
    
// „Éá„Éê„ÉÉ„Ç∞Áî®Ôºö„É¨„É≥„ÉÄ„É™„É≥„Ç∞È†ªÂ∫¶Ë®àÊ∏¨
private int _renderCount = 0;
private DateTime _lastFpsLog = DateTime.UtcNow;
    
protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender)
    {
        // CanvasÂàùÊúüÂåñ
        var success = await JS.InvokeAsync<bool>("canvasRenderer.initialize", _canvasId);
        if (success)
        {
            _isInitialized = true;
            _previousGridColumnCount = GridColumnCount;
            await RenderCanvas();
        }
    }
    else if (_isInitialized)
    {
        // „Ç∞„É™„ÉÉ„ÉâÂàóÊï∞„ÅåÂ§â„Çè„Å£„ÅüÂ†¥Âêà„ÅÆË®òÈå≤ÔºàResizeObserver„ÅåËá™Âãï„É™„Çµ„Ç§„Ç∫ÔºÜÂÜçÊèèÁîªÔºâ
        if (_previousGridColumnCount != GridColumnCount)
        {
            DebugSettings.Log($"[CanvasRenderer] Grid column count changed: {_previousGridColumnCount} -> {GridColumnCount} for canvas {_canvasId}");
            _previousGridColumnCount = GridColumnCount;
        }
            
        // ÊèèÁîª
        await RenderCanvas();
            
        // üîç „Éá„Éê„ÉÉ„Ç∞Ôºö„É¨„É≥„ÉÄ„É™„É≥„Ç∞È†ªÂ∫¶„Çí„É≠„Ç∞Âá∫Âäõ
        _renderCount++;
        var now = DateTime.UtcNow;
        var elapsed = (now - _lastFpsLog).TotalSeconds;
        if (elapsed >= 1.0)
        {
            DebugSettings.Log($"[CanvasRenderer] {_canvasId.Substring(0, 12)}... Render FPS: {_renderCount / elapsed:F1}");
            _renderCount = 0;
            _lastFpsLog = now;
        }
    }
}
    
    private async Task RenderCanvas()
    {
        if (!_isInitialized || State == null) return;
        
        try
        {
            await JS.InvokeVoidAsync("canvasRenderer.updateData",
                _canvasId,  // Canvas ID„ÇíÊúÄÂàù„ÅÆÂºïÊï∞„Å®„Åó„Å¶Ê∏°„Åô
                State.MainArray,
                State.CompareIndices.ToArray(),
                State.SwapIndices.ToArray(),
                State.ReadIndices.ToArray(),
                State.WriteIndices.ToArray(),
                State.IsSortCompleted,
                State.BufferArrays,
                State.ShowCompletionHighlight);
        }
        catch (Exception ex)
        {
            DebugSettings.Log($"Canvas render error: {ex.Message}");
        }
    }
    
    private async Task OnCanvasClick()
    {
        await OnClick.InvokeAsync();
    }
    
    public async ValueTask DisposeAsync()
    {
        DebugSettings.Log($"[CanvasRenderer] DisposeAsync called for canvas: {_canvasId}");
        
        if (_isInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("canvasRenderer.dispose", _canvasId);
                DebugSettings.Log($"[CanvasRenderer] Successfully disposed canvas: {_canvasId}");
            }
            catch (Exception ex)
            {
                DebugSettings.Log($"[CanvasRenderer] ERROR disposing canvas {_canvasId}: {ex.Message}");
            }
        }
        else
        {
            DebugSettings.Log($"[CanvasRenderer] Canvas {_canvasId} was not initialized, skipping dispose");
        }
    }
}
