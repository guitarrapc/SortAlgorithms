@using SortAlgorithm.VisualizationWeb.Models
@using SortAlgorithm.VisualizationWeb.Services
@inject Microsoft.JSInterop.IJSRuntime JS

<div class="stat-item">
    <button class="primary" @onclick="OnGenerateAndSort" style="width: 100%;">üé≤ Generate & Sort</button>
</div>

<div class="stat-item stat-item-vertical">
    <span class="stat-label">Operations Per Frame</span>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <span class="stat-value" style="font-size: 0.9rem;">@Playback.OperationsPerFrame ops/frame</span>
    </div>
    <input type="range" min="1" max="1000" @bind="Playback.OperationsPerFrame" @bind:after="HandleSpeedChanged" style="width: 100%;" />
</div>

<div class="stat-item stat-item-vertical">
    <span class="stat-label">Speed Multiplier</span>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <span class="stat-value" style="font-size: 0.9rem;">@Playback.SpeedMultiplier.ToString("F1")x</span>
        <span style="font-size: 0.85rem; color: #999;">(@EffectiveFPS FPS)</span>
    </div>
    <input type="range" min="0.5" max="100" step="0.5" @bind="Playback.SpeedMultiplier" @bind:after="HandleSpeedChanged" style="width: 100%;" />
</div>

<div class="stat-item">
    <label class="toggle-switch">
        <input type="checkbox" @bind="Playback.AutoReset" />
        <span class="toggle-slider"></span>
        <span class="toggle-label">Auto Reset on Complete</span>
    </label>
</div>

<div class="stat-item">
    <label class="toggle-switch">
        <input type="checkbox" @bind="Playback.SoundEnabled" @bind:after="HandleSoundToggleChanged" />
        <span class="toggle-slider"></span>
        <span class="toggle-label">üîä Sound</span>
    </label>
</div>

@if (Playback.SoundEnabled)
{
    <div class="stat-item stat-item-vertical">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span class="stat-label">Volume</span>
            <span class="stat-value" style="font-size: 0.9rem;">@((int)(Playback.SoundVolume * 100))%</span>
        </div>
        <input type="range" min="0" max="1" step="0.05" @bind="Playback.SoundVolume" style="width: 100%;" />
        @if (Playback.SpeedMultiplier > 50)
        {
            <span style="font-size: 0.8em; color: #f59e0b; margin-top: 4px; display: block;">‚ö†Ô∏è Muted (speed &gt; 50x)</span>
        }
    </div>
}

<div class="stat-item">
    <label class="toggle-switch">
        <input type="checkbox" @bind="Playback.InstantMode" />
        <span class="toggle-slider"></span>
        <span class="toggle-label">Instant Mode (No Animation)</span>
    </label>
</div>

@code {
    [Parameter, EditorRequired]
    public PlaybackService Playback { get; set; } = default!;

    [Parameter]
    public EventCallback OnGenerateAndSort { get; set; }

    [Parameter]
    public EventCallback OnSpeedSettingsChanged { get; set; }

    private int EffectiveFPS => (int)(60 * Playback.SpeedMultiplier);

    private async Task HandleSpeedChanged()
    {
        await OnSpeedSettingsChanged.InvokeAsync();
    }

    private async Task HandleSoundToggleChanged()
    {
        if (Playback.SoundEnabled)
        {
            await Playback.InitSoundAsync();
        }
    }
}
