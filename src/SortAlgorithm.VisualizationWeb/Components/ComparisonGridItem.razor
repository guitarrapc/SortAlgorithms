@using SortAlgorithm.VisualizationWeb.Models
@using SortAlgorithm.VisualizationWeb.Services
@inject DebugSettings DebugSettings
@implements IDisposable

<div class="comparison-grid-item @(Instance.State.IsSortCompleted ? "completed" : "")">
    <div class="comparison-header">
        <h4 class="algorithm-title">@Instance.AlgorithmName</h4>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="complexity-badge">@Instance.Metadata.TimeComplexity</span>
            <button class="btn-remove-grid" 
                    @onclick="HandleRemove"
                    title="Remove this algorithm">
                âœ–
            </button>
        </div>
    </div>
    
    <div class="comparison-visualization">
        @if (VisualizationMode == VisualizationMode.BarChart)
        {
            <CanvasChartRenderer 
                State="@Instance.State"
                GridColumnCount="@GridColumnCount"
                OnClick="@OnVisualizationClick" />
        }
        else if (VisualizationMode == VisualizationMode.Circular)
        {
            <CircularRenderer 
                State="@Instance.State"
                GridColumnCount="@GridColumnCount"
                OnClick="@OnVisualizationClick" />
        }
    </div>
    
    <ComparisonStatsSummary State="@Instance.State" />
</div>

@code {
    [Parameter, EditorRequired]
    public ComparisonInstance Instance { get; set; } = null!;
    
    [Parameter, EditorRequired]
    public PlaybackService Playback { get; set; } = null!;
    
    [Parameter]
    public VisualizationMode VisualizationMode { get; set; } = VisualizationMode.BarChart;
    
    [Parameter]
    public int GridColumnCount { get; set; } = 1;
    
    [Parameter]
    public EventCallback OnRemove { get; set; }
    
    [Parameter]
    public EventCallback OnVisualizationClick { get; set; }
    
    private PlaybackService? _previousPlayback;
    
    protected override void OnInitialized()
    {
        // ğŸ”§ é‡è¦ï¼šPlaybackService.StateChanged ã‚’ç›´æ¥è³¼èª­
        // ã“ã‚Œã«ã‚ˆã‚Šã€ComparisonGridå…¨ä½“ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã®ã‚’é˜²ã
        SubscribeToPlayback();
    }
    
    protected override void OnParametersSet()
    {
        // PlaybackServiceãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ã‚’æ›´æ–°
        if (_previousPlayback != Playback)
        {
            DebugSettings.Log($"[ComparisonGridItem] Playback changed for {Instance.AlgorithmName}");
            
            // å¤ã„PlaybackServiceã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­è§£é™¤
            if (_previousPlayback != null)
            {
                _previousPlayback.StateChanged -= OnPlaybackStateChanged;
                DebugSettings.Log($"[ComparisonGridItem] Unsubscribed from old PlaybackService");
            }
            
            // æ–°ã—ã„PlaybackServiceã«ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
            SubscribeToPlayback();
        }
    }
    
    private void SubscribeToPlayback()
    {
        if (Playback != null)
        {
            Playback.StateChanged += OnPlaybackStateChanged;
            _previousPlayback = Playback;
            DebugSettings.Log($"[ComparisonGridItem] Subscribed to PlaybackService for {Instance.AlgorithmName}");
        }
    }
    
    private void OnPlaybackStateChanged()
    {
        // ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã ã‘ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        InvokeAsync(StateHasChanged);
    }
    
    private async Task HandleRemove()
    {
        if (OnRemove.HasDelegate)
        {
            await OnRemove.InvokeAsync();
        }
    }
    
    public void Dispose()
    {
        DebugSettings.Log($"[ComparisonGridItem] Disposing item: {Instance.AlgorithmName}");
        
        try
        {
            // ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­è§£é™¤
            if (_previousPlayback != null)
            {
                _previousPlayback.StateChanged -= OnPlaybackStateChanged;
                DebugSettings.Log($"[ComparisonGridItem] Event unsubscribed successfully for {Instance.AlgorithmName}");
            }
        }
        catch (Exception ex)
        {
            DebugSettings.Log($"[ComparisonGridItem] ERROR during dispose: {ex.Message}");
        }
    }
}


