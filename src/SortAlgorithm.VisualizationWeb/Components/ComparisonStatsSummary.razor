@using SortAlgorithm.VisualizationWeb.Models

<div class="comparison-stats-summary">
    <div class="stat-mini">
        <span class="label">⏱</span>
        <span class="value stat-execution-time">@ExecutionTimeDisplay</span>
    </div>
    <div class="stat-mini">
        <span class="label">Compares:</span>
        <span class="value">@State.CompareCount.ToString("N0")</span>
    </div>
    <div class="stat-mini">
        <span class="label">Swaps:</span>
        <span class="value">@State.SwapCount.ToString("N0")</span>
    </div>
    <div class="stat-mini">
        <span class="label">Progress:</span>
        <span class="value">@GetProgressPercentage()%</span>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public VisualizationState State { get; set; } = null!;

    private int GetProgressPercentage()
    {
        if (State.TotalOperations == 0) return 0;
        return (int)((State.CurrentOperationIndex / (double)State.TotalOperations) * 100);
    }

    private bool IsPlaying => State.PlaybackState == PlaybackState.Playing;

    private string ExecutionTimeDisplay
    {
        get
        {
            if (State.ActualExecutionTime == TimeSpan.Zero)
                return "-";
            if (IsPlaying)
                return $"{FormatTime(State.EstimatedCurrentExecutionTime)} / {FormatTotalTime(State.ActualExecutionTime)}";
            return FormatTotalTime(State.ActualExecutionTime);
        }
    }

    private static string FormatTime(TimeSpan time)
    {
        if (time.TotalNanoseconds < 1000)
            return $"{time.TotalNanoseconds:F0} ns";
        else if (time.TotalMicroseconds < 1000)
            return $"{time.TotalMicroseconds:F1} μs";
        else if (time.TotalMilliseconds < 1000)
            return $"{time.TotalMilliseconds:F3} ms";
        else
            return $"{time.TotalSeconds:F3} s";
    }

    private static string FormatTotalTime(TimeSpan time)
    {
        if (time.TotalNanoseconds < 1000)
            return $"{time.TotalNanoseconds:F0} ns";
        else if (time.TotalMicroseconds < 1000)
            return $"{TrimTrailingZerosMinOne(time.TotalMicroseconds)} μs";
        else if (time.TotalMilliseconds < 1000)
            return $"{TrimTrailingZerosMinOne(time.TotalMilliseconds)} ms";
        else
            return $"{TrimTrailingZerosMinOne(time.TotalSeconds)} s";
    }

    private static string TrimTrailingZerosMinOne(double value)
    {
        var s = value.ToString("F3").TrimEnd('0');
        if (s.EndsWith('.'))
            s += "0";
        return s;
    }
}

