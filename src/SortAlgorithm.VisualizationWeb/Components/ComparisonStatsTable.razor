@using SortAlgorithm.VisualizationWeb.Models
@using SortAlgorithm.VisualizationWeb.Services
@inject IJSRuntime JS
@inject DebugSettings DebugSettings

<!-- ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ï¼ˆå³ç«¯ã«å›ºå®šï¼‰ -->
<button class="stats-panel-toggle @(IsOpen ? "open" : "")" 
        @onclick="TogglePanel"
        title="@(IsOpen ? "Hide Statistics" : "Show Statistics")">
    @(IsOpen ? "ðŸ“Š â–¶" : "â—€ ðŸ“Š")
</button>

<!-- çµ±è¨ˆãƒ‘ãƒãƒ«ï¼ˆå³å´ã«ãƒ‰ãƒƒã‚¯ï¼‰ -->
<div class="comparison-stats-panel @(IsOpen ? "open" : "")">
    <div class="stats-panel-header">
        <h3>ðŸ“Š Statistics Comparison</h3>
        <div class="stats-panel-actions">
            <button class="copy-button" @onclick="CopyTableToClipboard" title="Copy to Clipboard">
                ðŸ“‹ Copy
            </button>
        </div>
    </div>
    
    <div class="table-wrapper">
        <table class="comparison-stats-table">
            <thead>
                <tr>
                    <th @onclick='() => SortBy("Algorithm")' class="sortable">
                        Algorithm @GetSortIcon("Algorithm")
                    </th>
                    <th @onclick='() => SortBy("Complexity")' class="sortable">
                        Complexity @GetSortIcon("Complexity")
                    </th>
                    <th @onclick='() => SortBy("Compares")' class="sortable">
                        Compares @GetSortIcon("Compares")
                    </th>
                    <th @onclick='() => SortBy("Swaps")' class="sortable">
                        Swaps @GetSortIcon("Swaps")
                    </th>
                    <th @onclick='() => SortBy("Reads")' class="sortable">
                        Reads @GetSortIcon("Reads")
                    </th>
                    <th @onclick='() => SortBy("Writes")' class="sortable">
                        Writes @GetSortIcon("Writes")
                    </th>
                    <th @onclick='() => SortBy("Progress")' class="sortable">
                        Progress @GetSortIcon("Progress")
                    </th>
                    <th @onclick='() => SortBy("ExecTime")' class="sortable">
                        Exec Time @GetSortIcon("ExecTime")
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in GetSortedInstances())
                {
                    <tr class="@(item.State.IsSortCompleted ? "completed" : "")">
                        <td class="algorithm-name">@item.AlgorithmName</td>
                        <td class="complexity">@item.Metadata.TimeComplexity</td>
                        <td class="stat-value">@item.State.CompareCount.ToString("N0")</td>
                        <td class="stat-value">@item.State.SwapCount.ToString("N0")</td>
                        <td class="stat-value">@item.State.IndexReadCount.ToString("N0")</td>
                        <td class="stat-value">@item.State.IndexWriteCount.ToString("N0")</td>
                        <td class="status">
                            @if (item.State.IsSortCompleted)
                            {
                                <span class="status-badge completed">100%</span>
                            }
                            else
                            {
                                var progress = item.State.TotalOperations > 0 
                                    ? (int)((item.State.CurrentOperationIndex / (double)item.State.TotalOperations) * 100)
                                    : 0;
                                <span class="status-badge running">@progress%</span>
                            }
                        </td>
                        <td class="stat-value exec-time">@FormatTotalTime(item.State.ActualExecutionTime)</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public List<ComparisonInstance> Instances { get; set; } = null!;
    
    [Parameter]
    public bool IsOpen { get; set; } = false;
    
    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }
    
    private string _sortColumn = "Compares";
    private bool _sortAscending = true;

    private static string FormatTotalTime(TimeSpan time)
    {
        if (time == TimeSpan.Zero) return "-";
        if (time.TotalNanoseconds < 1000)
            return $"{time.TotalNanoseconds:F0} ns";
        else if (time.TotalMicroseconds < 1000)
            return $"{TrimTrailingZerosMinOne(time.TotalMicroseconds)} Î¼s";
        else if (time.TotalMilliseconds < 1000)
            return $"{TrimTrailingZerosMinOne(time.TotalMilliseconds)} ms";
        else
            return $"{TrimTrailingZerosMinOne(time.TotalSeconds)} s";
    }

    private static string TrimTrailingZerosMinOne(double value)
    {
        var s = value.ToString("F3").TrimEnd('0');
        if (s.EndsWith('.'))
            s += "0";
        return s;
    }
    
    private async Task TogglePanel()
    {
        IsOpen = !IsOpen;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }
    
    private void SortBy(string column)
    {
        if (_sortColumn == column)
        {
            _sortAscending = !_sortAscending;
        }
        else
        {
            _sortColumn = column;
            _sortAscending = true;
        }
    }
    
    private string GetSortIcon(string column)
    {
        if (_sortColumn != column) return "";
        return _sortAscending ? "â–²" : "â–¼";
    }
    
    private IEnumerable<ComparisonInstance> GetSortedInstances()
    {
        IEnumerable<ComparisonInstance> sorted = _sortColumn switch
        {
            "Algorithm" => _sortAscending 
                ? Instances.OrderBy(x => x.AlgorithmName)
                : Instances.OrderByDescending(x => x.AlgorithmName),
            "Complexity" => _sortAscending
                ? Instances.OrderBy(x => x.Metadata.TimeComplexity)
                : Instances.OrderByDescending(x => x.Metadata.TimeComplexity),
            "Compares" => _sortAscending
                ? Instances.OrderBy(x => x.State.CompareCount)
                : Instances.OrderByDescending(x => x.State.CompareCount),
            "Swaps" => _sortAscending
                ? Instances.OrderBy(x => x.State.SwapCount)
                : Instances.OrderByDescending(x => x.State.SwapCount),
            "Reads" => _sortAscending
                ? Instances.OrderBy(x => x.State.IndexReadCount)
                : Instances.OrderByDescending(x => x.State.IndexReadCount),
            "Writes" => _sortAscending
                ? Instances.OrderBy(x => x.State.IndexWriteCount)
                : Instances.OrderByDescending(x => x.State.IndexWriteCount),
            "Progress" => _sortAscending
                ? Instances.OrderBy(x => x.State.TotalOperations > 0 ? (x.State.CurrentOperationIndex / (double)x.State.TotalOperations) : 0)
                : Instances.OrderByDescending(x => x.State.TotalOperations > 0 ? (x.State.CurrentOperationIndex / (double)x.State.TotalOperations) : 0),
            "ExecTime" => _sortAscending
                ? Instances.OrderBy(x => x.State.ActualExecutionTime)
                : Instances.OrderByDescending(x => x.State.ActualExecutionTime),
            _ => Instances
        };
        
        return sorted;
    }
    
    private async Task CopyTableToClipboard()
    {
        // TSVå½¢å¼ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        var header = "Algorithm\tComplexity\tCompares\tSwaps\tReads\tWrites\tProgress\tExec Time";
        var rows = Instances.Select(item =>
        {
            var progress = item.State.TotalOperations > 0
                ? (int)((item.State.CurrentOperationIndex / (double)item.State.TotalOperations) * 100)
                : 0;
            
            return $"{item.AlgorithmName}\t" +
                   $"{item.Metadata.TimeComplexity}\t" +
                   $"{item.State.CompareCount}\t" +
                   $"{item.State.SwapCount}\t" +
                   $"{item.State.IndexReadCount}\t" +
                   $"{item.State.IndexWriteCount}\t" +
                   $"{(item.State.IsSortCompleted ? "100%" : $"{progress}%")}\t" +
                   $"{FormatTotalTime(item.State.ActualExecutionTime)}";
        });
        
        var tsv = header + "\n" + string.Join("\n", rows);
        
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", tsv);
            DebugSettings.Log("[ComparisonStatsTable] Table copied to clipboard");
        }
        catch (Exception ex)
        {
            DebugSettings.Log($"[ComparisonStatsTable] Failed to copy: {ex.Message}");
        }
    }
}
